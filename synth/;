use super::effect_conf::GenEffectConf;
use super::{KeyIndex, Octave};
use crate::synth::synth::Synth;
use esp_idf_svc::hal::adc::{AdcDriver, ADC1};
use esp_idf_svc::hal::gpio::{AnyInputPin, AnyOutputPin, OutputPin, PinDriver};
use std::sync::{Arc, Mutex};

pub struct Scanner {
    pressed: Vec<KeyIndex>,
    octave: Octave,
    tick_i: u8,
    trem_conf: GenEffectConf,
    echo_conf: GenEffectConf,
    columns: Arc<[PinDriver<'static, AnyOutputPin>]>,
    rows: Arc<[AnyInputPin]>,
    vol_pot: AnyInputPin,
    echo_vol_pot: AnyInputPin,
    echo_speed_pot: AnyInputPin,
    trem_vol_pot: AnyInputPin,
    trem_speed_pot: AnyInputPin,
    adc: AdcDriver<'static, ADC1>,
}

impl Scanner {
    pub fn step(&mut self, synth: &Arc<Mutex<Synth>>) {
        // TODO: scan the key matrix and change notes accordingly
        for col_i in 0..self.columns.len() {
            self.columns[col_i].set_high();
            self.columns[col_i].set_low();
        }

        // TODO: average three readings from each knob and change effect settings accordingly

        self.tick_i += 1;
    }
}
